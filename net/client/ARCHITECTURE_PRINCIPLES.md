# ARCHITECTURE PRINCIPLES - –ù–ï –ù–ê–†–£–®–ê–¢–¨!

## üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ò–ù–¶–ò–ü–´

### 1. **–ù–ï –ò–ó–û–ë–†–ï–¢–ê–¢–¨ –í–ï–õ–û–°–ò–ü–ï–î**
- Session/Stream API –£–ñ–ï —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ï
- –ù–ï —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–∏–ø–∞ `create_and_connect` 
- –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ `dap_http2_session_create()` + `dap_http2_session_connect()`
- –ê–î–ê–ü–¢–ò–†–û–í–ê–¢–¨ –ª–æ–≥–∏–∫—É —Å—Ç–∞—Ä–æ–≥–æ –º–æ–¥—É–ª—è –∫ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ, –∞ –ù–ï –Ω–∞–æ–±–æ—Ä–æ—Ç

### 2. **–£–ù–ò–í–ï–†–°–ê–õ–¨–ù–û–°–¢–¨ –°–õ–û–Å–í**
- **Session Layer**: —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –¥–ª—è –í–°–ï–• –∫–ª–∏–µ–Ω—Ç–æ–≤ (HTTP, WebSocket, Binary, etc.)
- **Stream Layer**: —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –¥–ª—è –í–°–ï–• –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- **Client Layer**: —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π —Ç–æ–ª—å–∫–æ –¥–ª—è HTTP –∫–ª–∏–µ–Ω—Ç–∞

### 3. **–î–ï–ö–û–ú–ü–û–ó–ò–¶–ò–Ø**
- Session: `create()` ‚Üí `connect()` ‚Üí `send()` ‚Üí `receive()`
- Stream: `create()` ‚Üí `set_callback()` ‚Üí `process_data()`
- Client: `create()` ‚Üí `request()` ‚Üí `callbacks`

### 4. **–°–í–ï–†–•–≠–§–§–ï–ö–¢–ò–í–ù–´–ô –ö–û–î** üöÄ
#### 4.1. –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏–π –ø–∞–º—è—Ç–∏
- **Enum –≤–º–µ—Å—Ç–æ —Å—Ç—Ä–æ–∫**: HTTP –º–µ—Ç–æ–¥—ã –∫–∞–∫ enum —Å O(1) –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ–º –≤ —Å—Ç—Ä–æ–∫–∏
- **NULL-–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–∞—Ä—Å–µ—Ä—ã**: –ø—Ä–∏–Ω–∏–º–∞—é—Ç NULL –¥–ª—è –Ω–µ–Ω—É–∂–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- **–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ**: –≤–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö malloc/free
- **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±—É—Ñ–µ—Ä–æ–≤**: –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ

#### 4.2. –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã
- **–†–∞–Ω–Ω–∏–π –≤—ã—Ö–æ–¥**: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–≤–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ –ø–µ—Ä–µ–¥ –ø–æ–ª–Ω—ã–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º —Å—Ç—Ä–æ–∫
- **–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–æ—Ö–æ–¥**: –ø–∞—Ä—Å–∏–Ω–≥ URL –∑–∞ –æ–¥–∏–Ω —Ü–∏–∫–ª –≤–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö strchr()
- **–†—É—á–Ω–æ–π –ø–∞—Ä—Å–∏–Ω–≥ —á–∏—Å–µ–ª**: –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö —á–∏—Å–µ–ª –±—ã—Å—Ç—Ä–µ–µ strtol()
- **–ú–∞—Å—Å–∏–≤—ã –≤–º–µ—Å—Ç–æ switch**: –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è enum ‚Üí string

#### 4.3. –ü—Ä–∏–Ω—Ü–∏–ø "—ç–∫–æ–Ω–æ–º–∏–º –Ω–∞ –∫–æ–ø–µ–π–∫–∞—Ö"
```c
// ‚ùå –ü–õ–û–•–û: –ª–∏—à–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è
char *method = dap_strdup("GET");

// ‚úÖ –•–û–†–û–®–û: enum –±–µ–∑ –≤—ã–¥–µ–ª–µ–Ω–∏–π  
dap_http_method_t method = DAP_HTTP_METHOD_GET;
const char *method_str = dap_http_method_to_string(method); // O(1)
```

```c
// ‚ùå –ü–õ–û–•–û: –≤—ã–¥–µ–ª—è–µ–º –ø–∞–º—è—Ç—å –¥–ª—è –Ω–µ–Ω—É–∂–Ω–æ–≥–æ path
s_parse_url(url, &host, &port, &path, &ssl);
DAP_DELETE(path); // –°—Ä–∞–∑—É —É–¥–∞–ª—è–µ–º!

// ‚úÖ –•–û–†–û–®–û: –Ω–µ –≤—ã–¥–µ–ª—è–µ–º –Ω–µ–Ω—É–∂–Ω–æ–µ
s_parse_url_efficient(url, &host, &port, NULL, &ssl); // path = NULL
```

#### 4.4. –†–∞–∑—É–º–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
```c
// ‚úÖ –•–û–†–û–®–û: —á–∏—Ç–∞–µ–º–æ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ
if (strncasecmp(url, "http://", 7) == 0)

// ‚úÖ –•–û–†–û–®–û: —Ä–∞–Ω–Ω–∏–π –≤—ã—Ö–æ–¥ –ø–æ –ø–µ—Ä–≤–æ–º—É —Å–∏–º–≤–æ–ª—É
switch (method_str[0]) {
    case 'G': if (strcmp(method_str, "GET") == 0) return DAP_HTTP_METHOD_GET;
    case 'P': if (strcmp(method_str, "POST") == 0) return DAP_HTTP_METHOD_POST;
}
```

### 5. **–ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨ –ë–ï–ó –ò–ó–ë–´–¢–û–ß–ù–û–°–¢–ò**
- –ü—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö **—Ç–æ–ª—å–∫–æ –≤ —Ç–æ—á–∫–∞—Ö –º—É—Ç–∞—Ü–∏–∏**
- –ù–ï –ø—Ä–æ–≤–µ—Ä—è—Ç—å buf corruption –≤ pop/consume —Ñ—É–Ω–∫—Ü–∏—è—Ö
- –í–∞–ª–∏–¥–∞—Ü–∏—è **—Ç–æ–ª—å–∫–æ —Ç–∞–º, –≥–¥–µ –æ—à–∏–±–∫–∏ –º–æ–≥—É—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å**

### 6. **–ü–†–ê–í–ò–õ–ê –ö–û–î–ê**
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Ñ—É–Ω–∫—Ü–∏–π –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º
- –ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ: `l_`, `a_`, `s_` –ø—Ä–µ—Ñ–∏–∫—Å—ã
- `DAP_NEW`, `DAP_DELETE`, `DAP_FREE` –º–∞–∫—Ä–æ—Å—ã
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∏ realloc
- –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

## üéØ –ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–û–î–•–û–î

### –í–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è `session_create_and_connect()`:
```c
// –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è
dap_http2_session_t* dap_http2_session_create_and_connect(host, port, ssl);

// –ü–†–ê–í–ò–õ–¨–ù–û - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
session = dap_http2_session_create(worker, timeout);
dap_http2_session_connect(session, host, port, ssl);
```

### –í–º–µ—Å—Ç–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è Session —Ñ—É–Ω–∫—Ü–∏–π –≤ Client:
```c
// –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –≤ Client
dap_http2_client_connect(client, host, port);

// –ü–†–ê–í–ò–õ–¨–ù–û - Client –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Session API
client->session = dap_http2_session_create(worker, timeout);
dap_http2_session_connect(client->session, host, port, ssl);
```

### –í–º–µ—Å—Ç–æ HTTP-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö Session —Ñ—É–Ω–∫—Ü–∏–π:
```c
// –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - HTTP –ª–æ–≥–∏–∫–∞ –≤ Session
dap_http2_session_send_http_request(session, request);

// –ü–†–ê–í–ò–õ–¨–ù–û - HTTP –ª–æ–≥–∏–∫–∞ –≤ Stream
stream = dap_http2_session_create_stream(session);
dap_http2_stream_set_http_client_mode(stream);
dap_http2_stream_send_request(stream, http_request);
```

## üîÑ –ü–†–ê–í–ò–õ–¨–ù–´–ô FLOW

### HTTP Client Request Flow:
1. **Client Layer**: 
   - –ü–∞—Ä—Å–∏—Ç URL (host, port, path)
   - –°–æ–∑–¥–∞—ë—Ç Session —á–µ—Ä–µ–∑ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π API
   - –°–æ–∑–¥–∞—ë—Ç Stream —á–µ—Ä–µ–∑ Session API
   - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç Stream –≤ HTTP —Ä–µ–∂–∏–º

2. **Stream Layer**:
   - –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç HTTP –∑–∞–ø—Ä–æ—Å
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑ session->send()
   - –ü–∞—Ä—Å–∏—Ç HTTP –æ—Ç–≤–µ—Ç –≤ read_callback
   - –£–≤–µ–¥–æ–º–ª—è–µ—Ç Client —á–µ—Ä–µ–∑ callbacks

3. **Session Layer**:
   - –£–ø—Ä–∞–≤–ª—è–µ—Ç TCP/SSL —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º
   - –ü–µ—Ä–µ–¥–∞—ë—Ç raw –¥–∞–Ω–Ω—ã–µ –≤ Stream
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–∞–π–º–∞—É—Ç—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

## üìã –ó–ê–î–ê–ß–ê: –ê–î–ê–ü–¢–ê–¶–ò–Ø, –ù–ï –ò–ó–û–ë–†–ï–¢–ï–ù–ò–ï

–ù–∞—à–∞ –∑–∞–¥–∞—á–∞ - –≤–∑—è—Ç—å –ª–æ–≥–∏–∫—É –∏–∑ `dap_client_http.c` –∏ **–†–ê–ó–õ–û–ñ–ò–¢–¨** –µ—ë –ø–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å–ª–æ—è–º:

- **–ü–∞—Ä—Å–∏–Ω–≥ URL** ‚Üí Client Layer
- **TCP connect + SSL** ‚Üí Session Layer  
- **HTTP formatting + parsing** ‚Üí Stream Layer
- **Streaming decision** ‚Üí Stream Layer
- **Chunked processing** ‚Üí Stream Layer
- **Redirects** ‚Üí Client Layer (—Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é Session)
- **Timeouts** ‚Üí Session Layer (connect) + Stream Layer (read)

## ‚ö†Ô∏è –ß–¢–û –ù–ï –î–ï–õ–ê–¢–¨

1. ‚ùå –°–æ–∑–¥–∞–≤–∞—Ç—å `session_create_and_connect()`
2. ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å Session API –≤ Client
3. ‚ùå –î–æ–±–∞–≤–ª—è—Ç—å HTTP –ª–æ–≥–∏–∫—É –≤ Session
4. ‚ùå –ò–∑–º–µ–Ω—è—Ç—å —É–∂–µ —É—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã
5. ‚ùå –°–æ–∑–¥–∞–≤–∞—Ç—å HTTP-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ Session —Ñ—É–Ω–∫—Ü–∏–∏

## ‚úÖ –ß–¢–û –î–ï–õ–ê–¢–¨

1. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π Session/Stream API
2. ‚úÖ –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É –∫ –Ω–æ–≤—ã–º —Å–ª–æ—è–º
3. ‚úÖ –°–æ—Ö—Ä–∞–Ω—è—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å Session/Stream
4. ‚úÖ HTTP-—Å–ø–µ—Ü–∏—Ñ–∏–∫—É —Ç–æ–ª—å–∫–æ –≤ Client + Stream callbacks
5. ‚úÖ –°–ª–µ–¥–æ–≤–∞—Ç—å –ø—Ä–∏–Ω—Ü–∏–ø—É —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ 

## üéØ **–†–ï–ó–£–õ–¨–¢–ê–¢**
–ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:
- ‚ö° **–ë—ã—Å—Ç—Ä—ã–º**: O(1) –æ–ø–µ—Ä–∞—Ü–∏–∏ –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ
- üíæ **–≠–∫–æ–Ω–æ–º–Ω—ã–º**: –º–∏–Ω–∏–º—É–º malloc/free
- üéØ **–¢–æ—á–Ω—ã–º**: —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
- üîß **–ü—Ä–æ—Å—Ç—ã–º**: —á–∏—Ç–∞–µ–º—ã–º –∏ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞–µ–º—ã–º 