# Chipmunk Implementation Structure Analysis

## Оригинальная структура (Rust)

### Основные параметры из param.rs:
```
N: 512                    // Степень полинома (ПРАВИЛЬНО в C версии)
SEC_PARAM: 112           // Параметр безопасности
ALPHA: 16                // Ненулевые элементы в рандомизаторе
HEIGHT: 5                // Высота дерева
ZETA: 29                 // База разложения: коэффициенты в [-zeta, zeta]
TWO_ZETA_PLUS_ONE: 59    // Арность: 2 * zeta + 1

HOTS_MODULUS: 3168257    // ОТЛИЧАЕТСЯ! В C версии: 8380417
HOTS_ONE_OVER_N: 3162069 // 1/N mod q
HOTS_MODULUS_OVER_TWO: 1584128
HOTS_WIDTH: 4            // Число элементов кольца при разложении
GAMMA: 6                 // Число полиномов в разложенном полиноме
ALPHA_H: 37              // Вес Хэмминга хеша сообщения
PHI: 13                  // Граница бесконечной нормы для s0
PHI_ALPHA_H: 481         // Граница нормы s_1 = phi * alpha_H

HVC_MODULUS: 202753      // Модуль для малого кольца
HVC_ONE_OVER_N: 202357   // 1/N mod q для малого кольца
```

## Текущая C реализация

### Константы в chipmunk.h:
```c
#define CHIPMUNK_N           512             // ✓ ПРАВИЛЬНО
#define CHIPMUNK_Q           8380417        // ❌ НЕПРАВИЛЬНО! Должно быть 3168257
#define CHIPMUNK_D           13             // ❌ НЕ ИСПОЛЬЗУЕТСЯ в оригинале
#define CHIPMUNK_TAU         39             // ❌ НЕ ИСПОЛЬЗУЕТСЯ в оригинале
#define CHIPMUNK_GAMMA1      (1 << 20)      // ❌ НЕПРАВИЛЬНО! Не соответствует оригиналу
#define CHIPMUNK_GAMMA2      ((CHIPMUNK_Q - 1) / 2) // ❌ НЕПРАВИЛЬНО
#define CHIPMUNK_BETA        2000000        // ❌ НЕПРАВИЛЬНО! Слишком большой
#define CHIPMUNK_K           4              // ❌ НЕ ИСПОЛЬЗУЕТСЯ в оригинале
```

## Структура модулей

### Оригинальная Rust структура:
```
src/
├── lib.rs              // Главный модуль
├── param.rs            // Параметры алгоритма
├── chipmunk/           // Основной алгоритм Chipmunk
│   ├── mod.rs          // Мультиподпись
│   ├── serialize.rs    // Сериализация
│   └── tests.rs        // Тесты
├── ots_sig/            // One-Time Signatures (HOTS)
│   ├── mod.rs          // Основная логика HOTS
│   ├── ots_keys.rs     // Ключи
│   ├── ots_param.rs    // Параметры
│   └── ots_sigs.rs     // Подписи
├── poly/               // Полиномиальная арифметика
│   ├── mod.rs          // Базовые полиномы
│   ├── hots/           // Полиномы для HOTS
│   ├── hvc/            // Полиномы для HVC
│   └── ter_poly.rs     // Тернарные полиномы
├── hash/               // Хеш функции
├── tree/               // Меркле дерево
├── encoding/           // Кодирование
└── randomizer.rs       // Рандомизация
```

### Текущая C структура:
```
dap-sdk/crypto/src/chipmunk/
├── chipmunk.h          // Основные определения ❌ НЕПРАВИЛЬНЫЕ ПАРАМЕТРЫ
├── chipmunk.c          // Основная реализация ❌ НЕПОЛНАЯ ЛОГИКА
├── chipmunk_poly.h     // Полиномиальные операции ❌ НЕПРАВИЛЬНАЯ АРИФМЕТИКА
├── chipmunk_poly.c     // Реализация полиномов ❌ НЕПРАВИЛЬНЫЕ АЛГОРИТМЫ
├── chipmunk_ntt.h      // NTT операции ❌ НЕПРАВИЛЬНЫЕ ПАРАМЕТРЫ NTT
├── chipmunk_ntt.c      // NTT реализация ❌ НЕПРАВИЛЬНЫЕ КОРНИ ЕДИНИЦЫ
├── chipmunk_hash.h     // Хеш функции ✓ ЧАСТИЧНО ПРАВИЛЬНО
├── chipmunk_hash.c     // Хеш реализация ✓ ЧАСТИЧНО ПРАВИЛЬНО
└── chipmunk_internal.h // Внутренние функции ❌ НЕПОЛНЫЕ
```

## Основные проблемы текущей реализации

### 1. Неправильные параметры:
- ❌ CHIPMUNK_Q = 8380417 (должно быть 3168257)
- ❌ CHIPMUNK_GAMMA1 = 2^20 (не используется в оригинале)
- ❌ CHIPMUNK_BETA = 2000000 (слишком большой)
- ❌ CHIPMUNK_TAU = 39 (не используется в оригинале)

### 2. Отсутствующие компоненты:
- ❌ HOTS (Homomorphic One-Time Signatures) - основа алгоритма
- ❌ HVC (Hash-to-Vector Commitment) полиномы  
- ❌ Дерево Меркле для агрегации
- ❌ Правильная рандомизация
- ❌ Разложение полиномов

### 3. Неправильная криптографическая логика:
- ❌ Неправильный алгоритм генерации ключей
- ❌ Неправильный алгоритм подписи
- ❌ Неправильный алгоритм верификации
- ❌ Отсутствие агрегации подписей

### 4. Неправильные NTT параметры:
- ❌ Корни единицы для q = 8380417 вместо q = 3168257
- ❌ Montgomery параметры для неправильного модуля

## План исправления

### Этап 1: Исправление параметров
1. Изменить CHIPMUNK_Q на 3168257
2. Удалить неиспользуемые константы (TAU, GAMMA1, GAMMA2, D, K)
3. Добавить правильные параметры из param.rs
4. Пересчитать NTT параметры для правильного модуля

### Этап 2: Реструктуризация модулей
1. Создать модуль HOTS (основа алгоритма)
2. Создать модуль HVC полиномов
3. Создать модуль дерева Меркле
4. Создать модуль рандомизации

### Этап 3: Исправление алгоритмов
1. Переписать генерацию ключей по оригинальному алгоритму
2. Переписать подпись по оригинальному алгоритму  
3. Переписать верификацию по оригинальному алгоритму
4. Добавить агрегацию подписей

### Этап 4: Тестирование
1. Создать тесты совместимости с оригинальной реализацией
2. Проверить векторы совместимости
3. Бенчмарки производительности

## Критичность проблем

### КРИТИЧНО (блокирует работу):
- Неправильный модуль q = 8380417 вместо 3168257
- Отсутствие HOTS алгоритма (основа Chipmunk)
- Неправильная полиномиальная арифметика

### ВАЖНО (влияет на безопасность):
- Неправильные параметры безопасности
- Отсутствие агрегации подписей
- Неправильная рандомизация

### СРЕДНЕ (влияет на совместимость):
- Неправильная сериализация
- Отсутствие всех интерфейсов API

## Заключение

Текущая C реализация Chipmunk **НЕ СООТВЕТСТВУЕТ** оригинальному алгоритму и **НЕ МОЖЕТ БЫТЬ ИСПОЛЬЗОВАНА** для блокчейн консенсуса в текущем виде. Требуется полная переработка с использованием правильных параметров и алгоритмов из оригинальной Rust реализации. 