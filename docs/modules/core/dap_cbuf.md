# DAP Circular Buffer (Кольцевой буфер)

## Обзор

Модуль `dap_cbuf` предоставляет реализацию кольцевого буфера (circular buffer, ring buffer) для эффективной работы с потоковыми данными в сетевых приложениях DAP SDK.

## Назначение

Кольцевой буфер - это структура данных, которая использует фиксированный размер буфера как непрерывное кольцо. Это позволяет эффективно обрабатывать потоки данных без необходимости перемещения больших объемов памяти.

## Основные возможности

- **Эффективная работа с потоками**: Минимальные операции копирования при добавлении/извлечении данных
- **Фиксированный размер**: Предотвращает неконтролируемый рост буфера
- **Потокобезопасность**: Может использоваться в многопоточной среде
- **Сетевая поддержка**: Встроенная поддержка отправки данных через сокеты

## Структура данных

```c
typedef struct dap_cbuf* dap_cbuf_t;  // Непрозрачный указатель на структуру
```

## API Функции

### Создание и уничтожение

```c
// Создание кольцевого буфера
dap_cbuf_t dap_cbuf_create(size_t size);

// Уничтожение кольцевого буфера
void dap_cbuf_delete(dap_cbuf_t cBuf);
```

### Управление данными

```c
// Сброс буфера (очистка всех данных)
void dap_cbuf_reset(dap_cbuf_t cBuf);

// Получение максимального размера буфера
size_t dap_cbuf_get_size_max(dap_cbuf_t cBuf);

// Получение текущего количества данных в буфере
size_t dap_cbuf_get_size(dap_cbuf_t cBuf);
```

### Операции ввода/вывода

```c
// Добавление данных в буфер (push)
void dap_cbuf_push(dap_cbuf_t cBuf, const void *src, size_t length);

// Извлечение данных из буфера (pop)
size_t dap_cbuf_pop(dap_cbuf_t cBuf, size_t length, void *dataOut);

// Чтение данных без извлечения (peek)
size_t dap_cbuf_read(dap_cbuf_t cBuf, size_t length, void *dataOut);
```

### Отладка и мониторинг

```c
// Печать содержимого буфера (для отладки)
void dap_cbuf_print(dap_cbuf_t cBuf, bool hex);
```

### Сетевая интеграция

```c
// Отправка данных через Unix сокет
int dap_cbuf_write_in_socket(dap_cbuf_t cBuf, int sockfd);
```

## Использование

### Базовый пример

```c
#include "dap_cbuf.h"

// Создание буфера размером 1024 байта
dap_cbuf_t buffer = dap_cbuf_create(1024);

// Добавление данных
const char *data = "Hello, World!";
dap_cbuf_push(buffer, data, strlen(data));

// Извлечение данных
char result[100];
size_t extracted = dap_cbuf_read(buffer, sizeof(result), result);

// Освобождение ресурсов
dap_cbuf_delete(buffer);
```

### Работа с сетевыми данными

```c
// Создание буфера для сетевых данных
dap_cbuf_t net_buffer = dap_cbuf_create(4096);

// Получение данных из сети
// ... сетевой код ...

// Отправка данных через сокет
int sockfd = socket(AF_INET, SOCK_STREAM, 0);
dap_cbuf_write_in_socket(net_buffer, sockfd);

// Очистка буфера для следующих данных
dap_cbuf_reset(net_buffer);
```

## Особенности реализации

- **Кольцевая структура**: Буфер представляет собой кольцо, где конец соединяется с началом
- **Не перемещает данные**: При достижении конца буфера новые данные записываются в начало
- **Эффективность**: O(1) операции для большинства функций
- **Потокобезопасность**: Требует внешней синхронизации при использовании в многопоточной среде

## Производительность

- **Вставка данных**: O(1) - постоянное время
- **Извлечение данных**: O(1) - постоянное время
- **Память**: Фиксированный размер, не растет динамически
- **CPU**: Минимальные накладные расходы

## Использование в DAP SDK

Кольцевые буферы широко используются в DAP SDK для:

- **Сетевых протоколов**: Буферизация входящих/исходящих сетевых пакетов
- **Потоковая обработка**: Работа с непрерывными потоками данных
- **Кэширование**: Временное хранение данных перед обработкой
- **Асинхронные операции**: Буферизация данных в асинхронных операциях

## Связанные модули

- `dap_stream.h` - Потоковая обработка данных
- `dap_net.h` - Сетевые операции
- `dap_common.h` - Общие утилиты DAP SDK

## Замечания по безопасности

- **Переполнение**: Буфер имеет фиксированный размер - проверяйте доступное пространство
- **Синхронизация**: При многопоточном использовании требуется внешняя синхронизация
- **Утечки памяти**: Всегда вызывайте `dap_cbuf_delete()` для освобождения ресурсов

## Отладка

Для отладки используйте функцию `dap_cbuf_print()`:

```c
dap_cbuf_print(buffer, true);  // Печать в hex формате
dap_cbuf_print(buffer, false); // Печать в ASCII формате
```

Это позволяет визуализировать содержимое буфера для анализа проблем.

