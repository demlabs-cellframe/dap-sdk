# Template Constructs - Mini Jinja2 для DAP Mock Templates

Система шаблонов поддерживает конструкции в стиле Jinja2 для более элегантной работы с данными.

## Поддерживаемые конструкции

### 1. Условные конструкции: `{{#if VAR}}...{{/if}}`

```bash
{{#if ENABLE_DEBUG}}
// Debug mode enabled
#define DEBUG_MODE 1
{{/if}}
```

С поддержкой `else`:

```bash
{{#if USE_NEW_API}}
// Using new API
#include "new_api.h"
{{else}}
// Using legacy API
#include "legacy_api.h"
{{/if}}
```

### 2. Циклы: `{{#for item in ARRAY}}...{{/for}}`

```bash
{{#for type in TYPES_ARRAY}}
// Process type: {{type}}
#define TYPE_{{type}} 1
{{/for}}
```

Массивы передаются через переменные окружения (newline или pipe-separated):

```bash
export TYPES_ARRAY="int
bool
char*"
```

Или pipe-separated:

```bash
export TYPES_ARRAY="int|bool|char*"
```

### 3. Установка переменных: `{{#set VAR=value}}`

```bash
{{#set MAX_SIZE=1024}}
{{#set ENABLE_FEATURE=yes}}

{{#if ENABLE_FEATURE}}
#define MAX_SIZE {{MAX_SIZE}}
{{/if}}
```

### 4. Вывод переменных: `{{VAR}}`

```bash
{{#set VERSION=1.0}}
// Generated for version {{VERSION}}
```

### 5. Подключение файлов: `{{#include FILE}}`

```bash
{{#if RETURN_TYPE_MACROS_FILE}}
{{#include RETURN_TYPE_MACROS_FILE}}
{{/if}}
```

Директива `{{#include}}` подключает содержимое указанного файла. Путь к файлу может быть переменной окружения или прямой строкой.

### 6. Встраиваемые AWK скрипты: `{{AWK:...}}` и `{{#awk:...}}`

AWK скрипты могут быть встроены в шаблон для обработки данных:

```bash
{{AWK:
BEGIN {
    print "// Generated by AWK"
    for (i = 1; i <= 10; i++) {
        print "#define VALUE_" i " " (i * 2)
    }
}
}}
```

AWK скрипты поддерживают `@include` для подключения библиотек:

```bash
{{AWK:
@include "dap_common.awk"

BEGIN {
    # Use functions from dap_common.awk
    result = trim_string("  hello  ")
    print result
}
}}
```

### 7. Shell скрипты: `{{#/bin/sh:...}}` (устарело, используйте язык шаблонов)

Для подготовки данных можно использовать shell скрипты:

```bash
{{#/bin/sh:
# Prepare data
export TYPES_ARRAY="int|bool|char*"
export VERSION="1.0"
}}
```

## Вложенные конструкции

**Вложенные конструкции полностью поддерживаются!** Можно использовать конструкции внутри других конструкций:

```bash
{{#if ENABLE_FEATURE}}
{{#for item in ITEMS_ARRAY}}
  {{#if item}}
    // Process item: {{item}}
    {{AWK:
    BEGIN {
        print "// Processed: " ENVIRON["item"]
    }
    }}
  {{/if}}
{{/for}}
{{/if}}
```

## Примеры использования

### Пример 1: Условная генерация макросов

```bash
{{#if POINTER_TYPES}}
// Pointer type macros
{{#for type in POINTER_TYPES_ARRAY}}
#define _DAP_MOCK_BASE_ESCAPE_{{type}} {{type}}_PTR
{{/for}}
{{/if}}
```

### Пример 2: Обработка данных с функциями (без AWK)

```bash
{{#if NORMALIZATION_MACROS_DATA}}
    {{#for entry in NORMALIZATION_MACROS_DATA}}
        {{entry|split|pipe}}
        {{#set macro_key={{entry|part|0}}}}
        {{#set base_type={{entry|part|1}}}}
        {{#set normalized_key={{entry|part|2}}}}
        
        {{#if macro_key|contains|*}}
            // Pointer type: {{macro_key}}
            #define TYPE_{{normalized_key}} {{base_type}}
        {{else}}
            // Non-pointer type: {{macro_key}}
            #define TYPE_{{normalized_key}} {{base_type}}
        {{/if}}
    {{/for}}
{{/if}}
```

### Пример 3: Обработка массивов с условиями и AWK (опционально)

```bash
{{AWK:
@include "dap_common.awk"

BEGIN {
    # Prepare TYPE_ENTRIES_ARRAY from NORMALIZATION_MACROS_DATA
    normalization_data = ENVIRON["NORMALIZATION_MACROS_DATA"]
    n_entries = split(normalization_data, entries, "\n")
    
    type_entries_array = ""
    for (i = 1; i <= n_entries; i++) {
        if (type_entries_array != "") {
            type_entries_array = type_entries_array "|" entries[i]
        } else {
            type_entries_array = entries[i]
        }
    }
    
    print type_entries_array
}
}}

{{#if TYPE_ENTRIES_ARRAY}}
{{#for entry in TYPE_ENTRIES_ARRAY}}
{{AWK:
@include "dap_common.awk"

BEGIN {
    entry_line = ENVIRON["entry"]
    # Process entry...
    print "// Entry: " entry_line
}
}}
{{/for}}
{{/if}}
```

### Пример 4: Комбинирование конструкций

```bash
{{#set SECTION_NAME="Type Normalization"}}
// ============================================================================
// {{SECTION_NAME}}
// ============================================================================

{{#if POINTER_TYPES_ARRAY}}
// Pointer types:
{{#for type_data in POINTER_TYPES_ARRAY}}
// Type: {{type_data}}
{{/for}}
{{else}}
// No pointer types found
{{/if}}
```

## Интеграция с существующими секциями

Новые конструкции работают вместе с существующими секциями:

```bash
{{#/bin/sh:
# Prepare data
export TYPES_ARRAY="int|bool|char*"
}}

{{#for type in TYPES_ARRAY}}
#define TYPE_{{type}} 1
{{/for}}

{{AWK:
# Post-process
{
    print
}
}}
```

## Переменные окружения в AWK скриптах

AWK скрипты имеют доступ ко всем переменным окружения через массив `ENVIRON`:

```bash
{{AWK:
BEGIN {
    # Access variables from loops
    item_value = ENVIRON["item"]
    
    # Access variables from shell scripts
    types_array = ENVIRON["TYPES_ARRAY"]
    
    # Process data
    print "Item: " item_value
}
}}
```

## Обработка данных в циклах

При использовании циклов `{{#for item in ARRAY}}`, переменная `item` доступна в AWK скриптах через `ENVIRON["item"]`:

```bash
{{#for entry in ENTRIES_ARRAY}}
{{AWK:
BEGIN {
    entry_line = ENVIRON["entry"]
    # Process entry_line
    print "// Processing: " entry_line
}
}}
{{/for}}
```

## Ограничения

1. Массивы должны быть переданы через переменные окружения
2. AWK скрипты выполняются в отдельном процессе
3. Переменные из циклов доступны только внутри блока цикла

## Будущие улучшения

- Поддержка фильтров (например, `{{item|upper}}`)
- Поддержка математических операций в условиях
- Кэширование результатов обработки
- Поддержка функций в шаблонах

## Отладка

Для отладки шаблонов можно использовать временные файлы:

```bash
{{AWK:
BEGIN {
    # Debug output
    print "DEBUG: TYPE_ENTRIES_ARRAY = " ENVIRON["TYPE_ENTRIES_ARRAY"] > "/dev/stderr"
}
}}
```

Временные AWK скрипты сохраняются в `/tmp/` для отладки:
- `/tmp/template_construct_awk_*.awk` - основные AWK скрипты
- `/tmp/awk_preprocessed_construct_*.awk` - препроцессированные скрипты с @include
- `/tmp/debug_preprocessed.awk` - последний препроцессированный скрипт
