## 6. Решение проблем

### Проблема: Тест зависает бесконечно
**Симптом:** Тест выполняется бесконечно без завершения  
**Причина:** Асинхронная операция никогда не сигнализирует о завершении  
**Решение:** Добавьте защиту глобальным таймаутом
```c
dap_test_global_timeout_t timeout;
if (dap_test_set_global_timeout(&timeout, 30, "Tests")) {
    log_it(L_ERROR, "Test timeout!");
}
```
**Профилактика:** Всегда используйте `DAP_TEST_WAIT_UNTIL` с разумным таймаутом

### Проблема: Высокая загрузка CPU
**Симптом:** 100% CPU во время теста  
**Решение:** Увеличьте интервал polling или используйте pthread helpers
```c
cfg.poll_interval_ms = 500;  // Менее частый polling
```

### Проблема: Мок не вызывается (выполняется реальная функция)
**Симптом:** Вызывается реальная функция вместо мока  
**Причина:** Отсутствует флаг линкера `--wrap`  
**Решение:** Проверьте конфигурацию CMake и флаги линкера
```bash
# Проверьте наличие флагов линкера
make VERBOSE=1 | grep -- "--wrap"

# Должно быть: -Wl,--wrap=function_name
```
**Исправление:** Убедитесь что `dap_mock_autowrap(target)` вызван после `add_executable()`

### Проблема: Неправильное возвращаемое значение
**Симптом:** Мок возвращает неожиданное значение  
**Решение:** Используйте правильное поле union
```c
.return_value.i = 42      // int
.return_value.l = 0xDEAD  // указатель
.return_value.ptr = ptr   // void*
```

### Проблема: Нестабильные тесты (периодические сбои)
**Симптом:** Иногда проходят, иногда падают  
**Причина:** Состояние гонки, недостаточные таймауты или предположения о времени  
**Решение:** Увеличьте таймауты и добавьте толерантность для проверок времени
```c
// Для сетевых операций - используйте щедрый таймаут
cfg.timeout_ms = 60000;  // 60 сек для сетевых операций

// Для проверок времени - используйте диапазон толерантности
uint64_t elapsed = measure_time();
assert(elapsed >= 90 && elapsed <= 150);  // ±50мс толерантность

// Используйте вариативную задержку для реалистичной симуляции
DAP_MOCK_SET_DELAY_VARIANCE(func, 100000, 50000);  // 100мс ± 50мс
```

### Проблема: Ошибка компиляции "undefined reference to __wrap"
**Симптом:** Ошибка линкера о `__wrap_function_name`  
**Решение:** Убедитесь что `dap_mock_autowrap()` вызван в CMakeLists.txt
```cmake
include(${CMAKE_SOURCE_DIR}/dap-sdk/test-framework/mocks/DAPMockAutoWrap.cmake)
dap_mock_autowrap(my_test)
```

### Проблема: Callback мока не выполняется
**Симптом:** Мок возвращает настроенное значение, но логика callback не выполняется  
**Причина:** Callback не зарегистрирован или мок отключен  
**Решение:** Проверьте что callback установлен и мок включен
```c
// Объявите с inline callback (предпочтительно)
DAP_MOCK_DECLARE(func_name, {.enabled = true}, {
    // Ваша логика callback здесь
    return (void*)42;
});

// Или установите callback в runtime
DAP_MOCK_SET_CALLBACK(func_name, my_callback, user_data);

// Убедитесь что мок включен
DAP_MOCK_ENABLE(func_name);
```
**Примечание:** Возвращаемое значение callback переопределяет конфигурацию `.return_value`

### Проблема: Мок не работает для функций в статической библиотеке
**Симптом:** Функции из статической библиотеки (`lib*.a`) не мокируются, вызывается реальная функция  
**Причина:** Одна из следующих:
- Линкер исключает неиспользуемые символы из статических библиотек (отсутствует `--whole-archive`)
- Используются объектные файлы (`.o`) вместо статических библиотек (`.a`)
- Не используется `dap_test_link_libraries()` (по умолчанию линкует объектные файлы)

**Решение (АВТОМАТИЧЕСКОЕ):** Используйте правильные helper-функции - мокирование полностью автоматическое!

```cmake
# Шаг 1: Линковать как STATIC библиотеки (не объектные файлы)
dap_test_link_libraries(test_target)

# Шаг 2: Добавить includes
dap_test_add_includes(test_target)

# Шаг 3: Включить мокирование - всё автоматически!
dap_mock_autowrap(test_target)
```

**Проверка исправления:**
```bash
# Проверить что --whole-archive применяется к статическим библиотекам
make VERBOSE=1 | grep -E "--whole-archive.*libdap.*_static"
# Должно быть: -Wl,--whole-archive ../../../../libdap_io_static.a -Wl,--no-whole-archive

# Проверить что используются статические библиотеки (не объектные файлы)
make VERBOSE=1 test_target 2>&1 | grep "Linking" -A 1 | grep "\.a"
# Должно быть: libdap_core_static.a libdap_io_static.a (а не .o файлы)
```

**Устаревший ручной подход (всё ещё работает):**
```cmake
dap_mock_autowrap(test_target)
dap_mock_autowrap_with_static(test_target dap_http_server)  # Опциональное переопределение
```

**Критичные замечания:** 
- **ОБЯЗАТЕЛЬНО использовать** `dap_test_link_libraries()` - автоматически создаёт статические библиотеки
- **Объектные файлы (`.o`) НЕ работают** с `--wrap` - только статические библиотеки (`.a`)
- **Почему:** Объектные файлы, слинкованные напрямую, имеют разрешённые символы во время линковки - нет косвенности для перехвата `--wrap`

### Проблема: Ошибка линкера "multiple definition"
**Симптом:** Ошибка `multiple definition of 'function_name'` при использовании `--whole-archive`  
**Причина:** Некоторые символы определены в нескольких библиотеках  
**Решение:** `dap_mock_autowrap_with_static()` автоматически добавляет `--allow-multiple-definition`, но если проблема сохраняется:

```cmake
# Явно добавьте флаг
target_link_options(test_target PRIVATE "-Wl,--allow-multiple-definition")
```

**Альтернатива:** Используйте `--whole-archive` только для конкретных библиотек, которые требуют мокирования

### Проблема: Задержка не работает
**Симптом:** Мок выполняется мгновенно несмотря на конфигурацию задержки  
**Решение:** Проверьте что задержка установлена после объявления мока
```c
DAP_MOCK_DECLARE(func_name);
DAP_MOCK_SET_DELAY_MS(func_name, 100);  // Установка после объявления
```

\newpage
