/*
* Authors:
* Roman Khlopkov <roman.khlopkov@demlabs.net>
* Cellframe       https://cellframe.net
* DeM Labs Inc.   https://demlabs.net
* Copyright  (c) 2017-2023
* All rights reserved.

This file is part of DAP SDK the open source project

DAP SDK is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

DAP SDK is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with any DAP SDK based project.  If not, see <http://www.gnu.org/licenses/>.
*/
#include "dap_crc64.h"

#define LOG_TAG "dap_crc64"

#define CRC64_ECMA182_POLY      0x42f0e1eba9ea3693ULL
#define CRC64_ISO_POLY          0x0000000000000001ULL
#define CRC64_MS_POLY           0x259c84cba6426349ULL
#define CRC64_REDIS_POLY        0xad93d23594c935a9ULL
#define CRC64_ISO_POLY_INV      0xd800000000000000ULL
#define CRC64_ECMA182_POLY_INV  0xc96c5795d7870f42ULL
#define CRC64_MS_POLY_INV       0x92c64265d32139a4ULL
#define CRC64_REDIS_POLY_INV    0x95ac9329ac4bc9b5ULL
#define CRC64_ROCKSOFT_POLY_INV 0x9a6c9329ac4bc9b5ULL

struct crc64_params {
    uint64_t poly;
    uint64_t init;
    bool reflected;
    uint64_t xorout;
    uint64_t check;
};

#define CRC64_PARAMS_ECMA182    {CRC64_ECMA182_POLY, UINT64_C(0), false, UINT64_C(0), 0x6c40df5f0b497347ULL}
#define CRC64_PARAMS_ISO        {CRC64_ISO_POLY_INV, UINT64_C(~0), true, UINT64_C(~0), 0xb90956c775a41001ULL}
#define CRC64_PARAMS_MS         {CRC64_MS_POLY_INV, UINT64_C(~0), true, UINT64_C(0), 0x75d4b74f024eceeaULL}
#define CRC64_PARAMS_REDIS      {CRC64_REDIS_POLY_INV, UINT64_C(0), true, UINT64_C(0), 0xe9c6d914c4b8d9caULL}
#define CRC64_PARAMS_WE         {CRC64_WE_POLY_INV, UINT64_C(~0), false, UINT64_C(~0), 0x62ec59e3f1a4f00aULL}
#define CRC64_PARAMS_XZ         {CRC64_ECMA182_POLY_INV, UINT64_C(~0), true, UINT64_C(~0), 0x995dc9bbdf1939faULL}

static const struct crc64_params c_crc64_params = CRC64_PARAMS_ISO;

static const DAP_ALIGNED(64) uint64_t s_crc64_table[256] =
{
    0x0000000000000000ULL, 0x01b0000000000000ULL, 0x0360000000000000ULL, 0x02d0000000000000ULL,
    0x06c0000000000000ULL, 0x0770000000000000ULL, 0x05a0000000000000ULL, 0x0410000000000000ULL,
    0x0d80000000000000ULL, 0x0c30000000000000ULL, 0x0ee0000000000000ULL, 0x0f50000000000000ULL,
    0x0b40000000000000ULL, 0x0af0000000000000ULL, 0x0820000000000000ULL, 0x0990000000000000ULL,
    0x1b00000000000000ULL, 0x1ab0000000000000ULL, 0x1860000000000000ULL, 0x19d0000000000000ULL,
    0x1dc0000000000000ULL, 0x1c70000000000000ULL, 0x1ea0000000000000ULL, 0x1f10000000000000ULL,
    0x1680000000000000ULL, 0x1730000000000000ULL, 0x15e0000000000000ULL, 0x1450000000000000ULL,
    0x1040000000000000ULL, 0x11f0000000000000ULL, 0x1320000000000000ULL, 0x1290000000000000ULL,
    0x3600000000000000ULL, 0x37b0000000000000ULL, 0x3560000000000000ULL, 0x34d0000000000000ULL,
    0x30c0000000000000ULL, 0x3170000000000000ULL, 0x33a0000000000000ULL, 0x3210000000000000ULL,
    0x3b80000000000000ULL, 0x3a30000000000000ULL, 0x38e0000000000000ULL, 0x3950000000000000ULL,
    0x3d40000000000000ULL, 0x3cf0000000000000ULL, 0x3e20000000000000ULL, 0x3f90000000000000ULL,
    0x2d00000000000000ULL, 0x2cb0000000000000ULL, 0x2e60000000000000ULL, 0x2fd0000000000000ULL,
    0x2bc0000000000000ULL, 0x2a70000000000000ULL, 0x28a0000000000000ULL, 0x2910000000000000ULL,
    0x2080000000000000ULL, 0x2130000000000000ULL, 0x23e0000000000000ULL, 0x2250000000000000ULL,
    0x2640000000000000ULL, 0x27f0000000000000ULL, 0x2520000000000000ULL, 0x2490000000000000ULL,
    0x6c00000000000000ULL, 0x6db0000000000000ULL, 0x6f60000000000000ULL, 0x6ed0000000000000ULL,
    0x6ac0000000000000ULL, 0x6b70000000000000ULL, 0x69a0000000000000ULL, 0x6810000000000000ULL,
    0x6180000000000000ULL, 0x6030000000000000ULL, 0x62e0000000000000ULL, 0x6350000000000000ULL,
    0x6740000000000000ULL, 0x66f0000000000000ULL, 0x6420000000000000ULL, 0x6590000000000000ULL,
    0x7700000000000000ULL, 0x76b0000000000000ULL, 0x7460000000000000ULL, 0x75d0000000000000ULL,
    0x71c0000000000000ULL, 0x7070000000000000ULL, 0x72a0000000000000ULL, 0x7310000000000000ULL,
    0x7a80000000000000ULL, 0x7b30000000000000ULL, 0x79e0000000000000ULL, 0x7850000000000000ULL,
    0x7c40000000000000ULL, 0x7df0000000000000ULL, 0x7f20000000000000ULL, 0x7e90000000000000ULL,
    0x5a00000000000000ULL, 0x5bb0000000000000ULL, 0x5960000000000000ULL, 0x58d0000000000000ULL,
    0x5cc0000000000000ULL, 0x5d70000000000000ULL, 0x5fa0000000000000ULL, 0x5e10000000000000ULL,
    0x5780000000000000ULL, 0x5630000000000000ULL, 0x54e0000000000000ULL, 0x5550000000000000ULL,
    0x5140000000000000ULL, 0x50f0000000000000ULL, 0x5220000000000000ULL, 0x5390000000000000ULL,
    0x4100000000000000ULL, 0x40b0000000000000ULL, 0x4260000000000000ULL, 0x43d0000000000000ULL,
    0x47c0000000000000ULL, 0x4670000000000000ULL, 0x44a0000000000000ULL, 0x4510000000000000ULL,
    0x4c80000000000000ULL, 0x4d30000000000000ULL, 0x4fe0000000000000ULL, 0x4e50000000000000ULL,
    0x4a40000000000000ULL, 0x4bf0000000000000ULL, 0x4920000000000000ULL, 0x4890000000000000ULL,
    0xd800000000000000ULL, 0xd9b0000000000000ULL, 0xdb60000000000000ULL, 0xdad0000000000000ULL,
    0xdec0000000000000ULL, 0xdf70000000000000ULL, 0xdda0000000000000ULL, 0xdc10000000000000ULL,
    0xd580000000000000ULL, 0xd430000000000000ULL, 0xd6e0000000000000ULL, 0xd750000000000000ULL,
    0xd340000000000000ULL, 0xd2f0000000000000ULL, 0xd020000000000000ULL, 0xd190000000000000ULL,
    0xc300000000000000ULL, 0xc2b0000000000000ULL, 0xc060000000000000ULL, 0xc1d0000000000000ULL,
    0xc5c0000000000000ULL, 0xc470000000000000ULL, 0xc6a0000000000000ULL, 0xc710000000000000ULL,
    0xce80000000000000ULL, 0xcf30000000000000ULL, 0xcde0000000000000ULL, 0xcc50000000000000ULL,
    0xc840000000000000ULL, 0xc9f0000000000000ULL, 0xcb20000000000000ULL, 0xca90000000000000ULL,
    0xee00000000000000ULL, 0xefb0000000000000ULL, 0xed60000000000000ULL, 0xecd0000000000000ULL,
    0xe8c0000000000000ULL, 0xe970000000000000ULL, 0xeba0000000000000ULL, 0xea10000000000000ULL,
    0xe380000000000000ULL, 0xe230000000000000ULL, 0xe0e0000000000000ULL, 0xe150000000000000ULL,
    0xe540000000000000ULL, 0xe4f0000000000000ULL, 0xe620000000000000ULL, 0xe790000000000000ULL,
    0xf500000000000000ULL, 0xf4b0000000000000ULL, 0xf660000000000000ULL, 0xf7d0000000000000ULL,
    0xf3c0000000000000ULL, 0xf270000000000000ULL, 0xf0a0000000000000ULL, 0xf110000000000000ULL,
    0xf880000000000000ULL, 0xf930000000000000ULL, 0xfbe0000000000000ULL, 0xfa50000000000000ULL,
    0xfe40000000000000ULL, 0xfff0000000000000ULL, 0xfd20000000000000ULL, 0xfc90000000000000ULL,
    0xb400000000000000ULL, 0xb5b0000000000000ULL, 0xb760000000000000ULL, 0xb6d0000000000000ULL,
    0xb2c0000000000000ULL, 0xb370000000000000ULL, 0xb1a0000000000000ULL, 0xb010000000000000ULL,
    0xb980000000000000ULL, 0xb830000000000000ULL, 0xbae0000000000000ULL, 0xbb50000000000000ULL,
    0xbf40000000000000ULL, 0xbef0000000000000ULL, 0xbc20000000000000ULL, 0xbd90000000000000ULL,
    0xaf00000000000000ULL, 0xaeb0000000000000ULL, 0xac60000000000000ULL, 0xadd0000000000000ULL,
    0xa9c0000000000000ULL, 0xa870000000000000ULL, 0xaaa0000000000000ULL, 0xab10000000000000ULL,
    0xa280000000000000ULL, 0xa330000000000000ULL, 0xa1e0000000000000ULL, 0xa050000000000000ULL,
    0xa440000000000000ULL, 0xa5f0000000000000ULL, 0xa720000000000000ULL, 0xa690000000000000ULL,
    0x8200000000000000ULL, 0x83b0000000000000ULL, 0x8160000000000000ULL, 0x80d0000000000000ULL,
    0x84c0000000000000ULL, 0x8570000000000000ULL, 0x87a0000000000000ULL, 0x8610000000000000ULL,
    0x8f80000000000000ULL, 0x8e30000000000000ULL, 0x8ce0000000000000ULL, 0x8d50000000000000ULL,
    0x8940000000000000ULL, 0x88f0000000000000ULL, 0x8a20000000000000ULL, 0x8b90000000000000ULL,
    0x9900000000000000ULL, 0x98b0000000000000ULL, 0x9a60000000000000ULL, 0x9bd0000000000000ULL,
    0x9fc0000000000000ULL, 0x9e70000000000000ULL, 0x9ca0000000000000ULL, 0x9d10000000000000ULL,
    0x9480000000000000ULL, 0x9530000000000000ULL, 0x97e0000000000000ULL, 0x9650000000000000ULL,
    0x9240000000000000ULL, 0x93f0000000000000ULL, 0x9120000000000000ULL, 0x9090000000000000ULL
};

static uint64_t s_crc64_update(uint64_t a_crc, const uint8_t *a_ptr, const size_t a_count)
{
    const uint8_t *const c_endptr = a_ptr + a_count;
    while (a_ptr < c_endptr)
        a_crc = s_crc64_table[((a_crc >> 56) ^ (*a_ptr++)) & 0xFF] ^ (a_crc << 8);
    return a_crc;
}

static uint64_t s_crc64_reflected_update(uint64_t a_crc, const uint8_t *a_ptr, const size_t a_count)
{
    const uint8_t *const c_endptr = a_ptr + a_count;
    while (a_ptr < c_endptr)
        a_crc = (a_crc >> 8) ^ s_crc64_table[(a_crc & 0xff) ^ *a_ptr++];
    return a_crc;
}

uint64_t crc64_update(uint64_t a_crc, const uint8_t *a_ptr, const size_t a_count)
{
    return c_crc64_params.reflected ? s_crc64_reflected_update(a_crc, a_ptr, a_count) : s_crc64_update(a_crc, a_ptr, a_count);
}


uint64_t crc64(const uint8_t *a_ptr, const size_t a_count)
{
    return crc64_update(c_crc64_params.init, a_ptr, a_count) ^ c_crc64_params.xorout;
}

// For different polynoms table regeneration

static void s_generate_reflected_crc64_table(uint64_t a_table[256], uint64_t a_poly)
{
    uint64_t i, j, c, crc;
    for (i = 0; i < 256; i++) {
        crc = 0ULL;
        c = i;
        for (j = 0; j < 8; j++) {
            if ((crc ^ (c >> j)) & 1)
                crc = (crc >> 1) ^ a_poly;
            else
                crc >>= 1;
        }
        a_table[i] = crc;
    }
}

static void s_generate_crc64_table(uint64_t a_table[256], uint64_t a_poly)
{
    uint64_t i, j, c, crc;
    for (i = 0; i < 256; i++) {
        crc = 0;
        c = i << 56;
        for (j = 0; j < 8; j++) {
            if ((crc ^ c) & 0x8000000000000000ULL)
                crc = (crc << 1) ^ a_poly;
            else
                crc <<= 1;
            c <<= 1;
        }
        a_table[i] = crc;
    }
}

static void s_print_crc64_table(uint64_t a_table[256])
{
    printf("{\n    ");
    int i;
    for (i = 0; i < 256; i++) {
        printf("0x%016" DAP_UINT64_FORMAT_x "ULL", a_table[i]);
        if (i % 4 == 3)
            printf(",\n    ");
        else
            printf(", ");
    }
    printf("};\n");
}

static void s_print_current_crc64_table()
{
    uint64_t l_table[256];
    if (c_crc64_params.reflected)
        s_generate_reflected_crc64_table(l_table, c_crc64_params.poly);
    else
        s_generate_crc64_table(l_table, c_crc64_params.poly);
    s_print_crc64_table(l_table);
}

static bool s_crc64_selfcheck()
{
    const unsigned char l_check[] = "123456789";
    return crc64(l_check, sizeof(l_check) - 1) == c_crc64_params.check;
}

int dap_crc64_init()
{
    //s_print_current_crc64_table();    // Uncomment this to print table with selected params on screen
    if (!s_crc64_selfcheck()) {
        log_it(L_CRITICAL, "CRC64 tables corrupted, can't init CRC64 module");
        return -1;
    }
    return 0;
}
